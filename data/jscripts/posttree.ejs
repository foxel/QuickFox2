var FOX2_POSTTREE = function()
{
    var inited = false,
        newPostID = 'post_new_block',
        newPostTmp = null,
        newPostParF = null,
        newPostActF = null,
        newPostTA = null,
        newPostStock = null,
        newPostOpened = false;
    var myEditors = {},
        editorOpened = '';

    var Init = function()
    {        newPostTmp = qf_getbyid(newPostID);
        if (!newPostTmp)
        {
            QF_TIMERS.addOnLoad(Init);
            return false;
        }
        newPostStock = newPostTmp.parentNode;
        QF_EFFECTS.ClearResizers(newPostTmp);
        var btnSave = qf_getbyid('post_new_btn_save');
        if (btnSave)
        {            var btnCancel = document.createElement('button');
            btnCancel.id = 'post_new_btn_canc';
            btnCancel.innerHTML = '{L_BTN_CANCEL}';
            btnCancel.onclick = function() { doCloseEditor(); return false; };
            btnSave.parentNode.insertBefore(btnCancel, btnSave.nextSibling);
        }
        QF_EFFECTS.Invisible(newPostID);
        inited = true;
        return true;
    }

    var doRenameFormIDs = function(item, new_prefix)
    {        if (item && item.children)
        {            if (item.id)
                item.id = item.id.replace(/^post_new_/, new_prefix+'_');
            for (var i=0; i < item.children.length; i++)
                doRenameFormIDs(item.children[i], new_prefix);
        }
    }

    var doSetFormValue = function(form, name, value)
    {        var inputs = form.getElementsByTagName('input');
        for (var i in inputs)
            if (inputs[i].name && inputs[i].name == name)
            {
                inputs[i].value = value;
                return true;
            }
        inputs = form.getElementsByTagName('textarea');
        for (var i in inputs)
            if (inputs[i].name && inputs[i].name == name && inputs[i].tagName && inputs[i].tagName.toLowerCase() == 'textarea')
            {
                inputs[i].value = value;
                return true;
            }

        return false;
    }

    var doEditorFocus = function(editorId)
    {        var ta = qf_getbyid(editorId+'_text');
        if (ta && ta.focus)
            ta.focus();
    }

    var doOpenEditor = function(postId, doEdit)
    {        var editorId = 'postEd'+postId+(doEdit ? '_edit' : '_answ');
        if (!myEditors[editorId])
        {            var divId = postId ? 'post'+postId : 'topic';
            var postDiv = qf_getbyid(divId);

            var clone = newPostTmp.cloneNode(true);
            doRenameFormIDs(clone, editorId);

            var parBlock = (doEdit) ? postDiv.parentNode : qf_getbyid(divId + '_answer');
            if (parBlock && parBlock.insertBefore)
                parBlock.insertBefore(clone, doEdit ? postDiv.nextSibling : null);
            QF_EFFECTS.Invisible(editorId+'_block');

            var btnCancel = qf_getbyid(editorId+'_btn_canc');
            if (btnCancel)
                btnCancel.onclick = function() { doCloseEditor(); return false; };

            if (!doEdit)
            {
                var tmp;
                if (tmp = qf_getbyid(editorId+'_editblock'))
                    tmp.parentNode.removeChild(tmp);
            }

            doSetFormValue(clone, 'post_id', postId);
            doSetFormValue(clone, 'action', doEdit ? 'editpost' : 'answer');

            myEditors[editorId] = {obj: clone, divId: divId, doEdit: doEdit};

            var ta = qf_getbyid(editorId+'_text');
            if (ta)
                QF_EFFECTS.SetResizebleElem(ta);
        }


        var editor = myEditors[editorId].obj;
        if (editorId != editorOpened)
        {
            doCloseEditor();
            QF_EFFECTS.Show(editorId+'_block', 3, 100, function() {doEditorFocus(editorId);});
            if (myEditors[editorId].doEdit)
                QF_EFFECTS.Hide(myEditors[editorId].divId, 3);
        }

        editorOpened = editorId;
        return editor;
    }

    var doCloseEditor = function()
    {        if (!editorOpened)
            return false;
        QF_EFFECTS.InitItem(editorOpened+'_block'); /* TODO: more accurate restoring of params */
        QF_EFFECTS.Hide(editorOpened+'_block', 3);
        if (myEditors[editorOpened].doEdit)
            QF_EFFECTS.Show(myEditors[editorOpened].divId, 3);
        editorOpened = '';
        return true;
    }

    var doPrepPostNode = function(postId)
    {        var divId = 'post'+postId;
        var postDiv = qf_getbyid(divId);
        var answBtn = qf_getbyid(divId+'_btn_answ');
        if (answBtn)
            answBtn.onclick = function() { FOX2_POSTTREE.OpenAnswer(postId); return false; };
        var editBtn = qf_getbyid(divId+'_btn_edit');
        if (editBtn)
            editBtn.onclick = function() { FOX2_POSTTREE.OpenEdit(postId); return false; };
    }

    var doSetWaiting = function(postId)
    {        var parId = postId ? 'post'+postId : 'topic';
        var answBtn = qf_getbyid(parId + '_btn_answ');
        var editBtn = qf_getbyid(parId + '_btn_edit');
        var tmp = (editBtn) ? editBtn : answBtn;
        if (tmp && tmp.parentNode && tmp.parentNode.insertBefore)
        {
            if (editBtn)
                getStyleObj(editBtn).display = 'none';
            if (answBtn)
                getStyleObj(answBtn).display = 'none';
            var img = document.createElement('img');
            img.id = parId + '_img_wait';
            img.src = '{IMGS}/loading.png';
            var stl = getStyleObj(img);
            stl.width = '80px';
            stl.height = '30px';
            tmp.parentNode.insertBefore(img, tmp);
        }
    }

    var doDropWaiting = function(postId)
    {
        var parId = postId ? 'post'+postId : 'topic';
        var answBtn = qf_getbyid(parId + '_btn_answ');
        var editBtn = qf_getbyid(parId + '_btn_edit');
        var img = qf_getbyid(parId + '_img_wait');
        var tmp = (editBtn) ? editBtn : answBtn;
        if (img && tmp && tmp.parentNode && tmp.parentNode.removeChild)
        {
            if (editBtn)
                getStyleObj(editBtn).display = '';
            if (answBtn)
                getStyleObj(answBtn).display = '';
            tmp.parentNode.removeChild(img);
        }
    }

    var doOpenEdit = function(postId, data, onOpen)
    {        var divId = 'post'+postId;
        var editor = doOpenEditor(postId, true);
        doSetFormValue(editor, 'post_text', data['o_text']);
    }

    var doCloseEdit = function(postId, onClose)
    {
    }

    var pub = {        PrepPosts: function(posts)
        {            if (!posts.length)
                return;

            for (var i in posts)
                doPrepPostNode(posts[i]);
        },
        OpenAnswer: function(postId)
        {            if (!inited && !Init())
                return Alert('{L_MISC_JS_WAIT}');

            doOpenEditor(postId);
        },
        OpenEdit: function(postId)
        {
            if (!inited && !Init())
                return Alert('{L_MISC_JS_WAIT}');

            if (editorOpened)
                doCloseEditor();


            var handle = function(status, data)
            {
                doDropWaiting(postId);
                if (status != 200)
                    alert(data);
                else
                    doOpenEdit(postId, data);
            }
            if (QF_AJAX.Query('ptree_getpost', {post_id: postId}, handle))
                doSetWaiting(postId);
        },
        SaveAnswer: function()
        {}
    };

    return pub;
}();