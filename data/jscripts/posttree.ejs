var FOX2_POSTTREE = function()
{
    var inited = false,
        newPostTmp = null,
        newPostParF = null,
        newPostActF = null,
        newPostTA = null,
        newPostStock = null,
        postEditOpened = 0;

    var Init = function()
    {        newPostTmp = qf_getbyid('new_post_form');
        if (!newPostTmp)
        {
            QF_TIMERS.addOnLoad(Init);
            return false;
        }
        newPostStock = newPostTmp.parentNode;

        var inputs = newPostTmp.getElementsByTagName('input');
        for (var i in inputs)
        {
            if (!inputs[i].name)
                continue;
            if (inputs[i].name == 'post_id')
                newPostParF = inputs[i];
            else if (inputs[i].name == 'action')
                newPostActF = inputs[i];
        }

        inputs = newPostTmp.getElementsByTagName('textarea');
        for (var i in inputs)
            if (inputs[i].name && inputs[i].tagName && inputs[i].tagName.toLowerCase() == 'textarea')
                newPostTA = inputs[i];

        inited = true;
        return true;
    }

    var SetPostFormValue = function(name, value)
    {        var inputs = newPostTmp.getElementsByTagName('input');
        for (var i in inputs)
            if (inputs[i].name && inputs[i].name == name)
            {
                inputs[i].value = value;
                return true;
            }
        inputs = newPostTmp.getElementsByTagName('textarea');
        for (var i in inputs)
            if (inputs[i].name && inputs[i].name == name && inputs[i].tagName && inputs[i].tagName.toLowerCase() == 'textarea')
            {
                inputs[i].value = value;
                return true;
            }

        return false;
    }

    var PrepPostNode = function(postId)
    {        var divId = 'post'+postId;
        var postDiv = qf_getbyid(divId);
        var answBtn = qf_getbyid(divId+'_btn_answ');
        if (answBtn)
            answBtn.onclick = function() { FOX2_POSTTREE.OpenAnswer(postId); return false; };
        var editBtn = qf_getbyid(divId+'_btn_edit');
        if (editBtn)
            editBtn.onclick = function() { FOX2_POSTTREE.OpenEdit(postId); return false; };
    }

    var doSetWaiting = function(postId)
    {        var parId = postId ? 'post'+postId : 'topic';
        var answBtn = qf_getbyid(parId + '_btn_answ');
        var editBtn = qf_getbyid(parId + '_btn_edit');
        var tmp = (editBtn) ? editBtn : answBtn;
        if (tmp && tmp.parentNode && tmp.parentNode.insertBefore)
        {
            if (editBtn)
                getStyleObj(editBtn).display = 'none';
            if (answBtn)
                getStyleObj(answBtn).display = 'none';
            var img = document.createElement('img');
            img.id = parId + '_img_wait';
            img.src = '{IMGS}/loading.png';
            var stl = getStyleObj(img);
            stl.width = '80px';
            stl.height = '30px';
            tmp.parentNode.insertBefore(img, tmp);
        }
    }

    var doDropWaiting = function(postId)
    {
        var parId = postId ? 'post'+postId : 'topic';
        var answBtn = qf_getbyid(parId + '_btn_answ');
        var editBtn = qf_getbyid(parId + '_btn_edit');
        var img = qf_getbyid(parId + '_img_wait');
        var tmp = (editBtn) ? editBtn : answBtn;
        if (img && tmp && tmp.parentNode && tmp.parentNode.removeChild)
        {
            if (editBtn)
                getStyleObj(editBtn).display = '';
            if (answBtn)
                getStyleObj(answBtn).display = '';
            tmp.parentNode.removeChild(img);
        }
    }

    var doOpenEdit = function(postId, data)
    {        var divId = 'post'+postId;
        var postDiv = qf_getbyid(divId);
        postDiv.parentNode.insertBefore(newPostTmp, postDiv);
        getStyleObj(postDiv).display = 'none';
        newPostParF.value = postId;
        newPostActF.value = 'editpost';
        newPostTA.value = data['o_text'];
        newPostTA.focus();
        postEditOpened = postId;
    }

    var doCloseEdit = function(postId)
    {
        var divId = 'post'+postId;
        var postDiv = qf_getbyid(divId);
        newPostStock.insertBefore(newPostTmp, null);
        getStyleObj(postDiv).display = '';
        postEditOpened = 0;
    }

    var pub = {        PrepPosts: function(posts)
        {            if (!posts.length)
                return;

            for (var i in posts)
                PrepPostNode(posts[i]);
        },
        OpenAnswer: function(postId)
        {            if (!inited && !Init())
                return Alert('{L_MISC_JS_WAIT}');

            if (postEditOpened)
                doCloseEdit(postEditOpened);

            var parId = postId ? 'post'+postId : 'topic';
            var parBlock = qf_getbyid(parId + '_answer');
            if (parBlock && parBlock.insertBefore)
            {
                parBlock.insertBefore(newPostTmp, null);
                newPostParF.value = postId;
                newPostActF.value = 'answer';
                newPostTA.value = '';
                newPostTA.focus();
            }
        },
        OpenEdit: function(postId)
        {
            if (!inited && !Init())
                return Alert('{L_MISC_JS_WAIT}');

            if (postEditOpened)
                doCloseEdit(postEditOpened);


            var handle = function(status, data)
            {
                doDropWaiting(postId);
                if (status != 200)
                    alert(data);
                else
                    doOpenEdit(postId, data);
            }
            if (QF_AJAX.Query('ptree_getpost', {post_id: postId}, handle))
                doSetWaiting(postId);
        },
        SaveAnswer: function()
        {}
    };

    return pub;
}();